#!/usr/bin/env python3
"""
Weather Icons SVG ‚Üí PNG Konvertering - MED H√ñGRE UPPL√ñSNINGAR
Ers√§tter befintliga felkonverterade PNG-filer med korrekta SVG-baserade versioner
Skapar √§ven nya h√∂gre uppl√∂sningar (64x64, 80x80, 120x120) f√∂r b√§ttre kvalitet
L√∂ser pixling-problemet genom att anv√§nda SVG-k√§llor direkt
"""

import os
import sys
import shutil
from pathlib import Path
from datetime import datetime
from PIL import Image, ImageEnhance
import logging

# Kontrollera att cairosvg finns i virtuell milj√∂
try:
    import cairosvg
    print("‚úÖ cairosvg tillg√§ngligt i virtuell milj√∂")
except ImportError:
    print("‚ùå cairosvg inte tillg√§ngligt!")
    print("üîß Aktivera virtuell milj√∂ f√∂rst: source .venv/bin/activate")
    sys.exit(1)

class WeatherIconsSVGConverter:
    """Konverterar SVG till PNG med exakt √∂verskrivning av befintliga filer PLUS h√∂gre uppl√∂sningar"""
    
    def __init__(self, svg_base_dir="weather-icons-master/svg", icons_dir="icons"):
        """
        Initialisera konverterare
        
        Args:
            svg_base_dir: Katalog med SVG-filer
            icons_dir: M√•lkatalog med befintliga PNG-filer
        """
        self.svg_base_dir = Path(svg_base_dir)
        self.icons_dir = Path(icons_dir)
        
        # Kontrollera att katalogerna finns
        if not self.svg_base_dir.exists():
            raise FileNotFoundError(f"SVG-katalog finns inte: {self.svg_base_dir}")
        if not self.icons_dir.exists():
            raise FileNotFoundError(f"Icons-katalog finns inte: {self.icons_dir}")
        
        # Setup logging
        logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
        self.logger = logging.getLogger(__name__)
        
        # Skapa backup-katalog
        self.backup_dir = Path(f"backup/svg_conversion_{datetime.now().strftime('%Y%m%d_%H%M%S')}")
        self.backup_dir.mkdir(parents=True, exist_ok=True)
        
        # R√§knare f√∂r statistik
        self.stats = {
            'converted': 0,
            'new_created': 0,
            'skipped': 0,
            'failed': 0,
            'backed_up': 0
        }
        
        print(f"üé® Weather Icons SVG‚ÜíPNG Converter - H√ñGRE UPPL√ñSNINGAR")
        print(f"üìÅ SVG k√§lla: {self.svg_base_dir}")
        print(f"üìÅ PNG m√•l: {self.icons_dir}")
        print(f"üíæ Backup: {self.backup_dir}")
        print(f"üöÄ Skapar √§ven nya storlekar: 64x64, 80x80, 96x96, 120x120")
    
    def get_conversion_mapping(self):
        """
        Definiera mappning fr√•n SVG till PNG-filer - NU MED H√ñGRE UPPL√ñSNINGAR
        Inkluderar befintliga storlekar + nya st√∂rre varianter
        """
        return {
            # KRITISKA PRESSURE-PILAR (l√∂ser avklippning + h√∂gre uppl√∂sning)
            'pressure': {
                'wi-direction-up': [
                    # Befintliga
                    (56, 56, ''), (20, 20, '_20'),
                    # NYA h√∂gre uppl√∂sningar
                    (96, 96, '_96'), (120, 120, '_120')
                ],
                'wi-direction-down': [
                    (56, 56, ''), (20, 20, '_20'),
                    (96, 96, '_96'), (120, 120, '_120')
                ],
                'wi-direction-right': [
                    (56, 56, ''), (20, 20, '_20'),
                    (96, 96, '_96'), (120, 120, '_120')
                ]
            },
            
            # SYSTEM-IKONER - UT√ñKADE STORLEKAR
            'system': {
                'wi-barometer': [
                    # Befintliga
                    (48, 48, ''), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (64, 64, '_64'),
                    # NYA storlekar
                    (80, 80, '_80'), (96, 96, '_96')
                ],
                'wi-refresh': [
                    (24, 24, ''), (16, 16, '_16'), (12, 12, '_12'),
                    # NYA storlekar
                    (32, 32, '_32'), (48, 48, '_48')
                ],
                'wi-strong-wind': [
                    (24, 24, ''), (16, 16, '_16'), (12, 12, '_12'),
                    (32, 32, '_32'), (48, 48, '_48')
                ],
                'wi-na': [
                    (24, 24, ''), (16, 16, '_16'), (12, 12, '_12'),
                    (32, 32, '_32'), (48, 48, '_48')
                ],
                'wi-day-sunny': [
                    (24, 24, ''), (16, 16, '_16'), (12, 12, '_12'),
                    (32, 32, '_32'), (48, 48, '_48')
                ],
                
                # TID-IKONER (12 stycken, ut√∂kade storlekar)
                'wi-time-1': [
                    (64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'),
                    # NYA storlekar
                    (80, 80, '_80'), (96, 96, '_96')
                ],
                'wi-time-2': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-3': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-4': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-5': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-6': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-7': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-8': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-9': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-10': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-11': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')],
                'wi-time-12': [(64, 64, '_64'), (48, 48, '_48'), (32, 32, '_32'), (24, 24, '_24'), (16, 16, '_16'), (12, 12, '_12'), (80, 80, '_80'), (96, 96, '_96')]
            },
            
            # SOL-IKONER - ST√ñRRE STORLEKAR
            'sun': {
                'wi-sunrise': [
                    # Befintliga
                    (40, 40, ''), (24, 24, '_24'),
                    # NYA storlekar f√∂r b√§ttre kvalitet
                    (56, 56, '_56'), (80, 80, '_80')
                ],
                'wi-sunset': [
                    (40, 40, ''), (24, 24, '_24'),
                    (56, 56, '_56'), (80, 80, '_80')
                ],
                'wi-day-sunny': [
                    (40, 40, ''), (24, 24, '_24'),
                    (56, 56, '_56'), (80, 80, '_80')
                ]
            },
            
            # WEATHER-IKONER - H√ñGRE UPPL√ñSNINGAR F√ñR HERO-MODULEN
            'weather': {
                'wi-cloud': [
                    # Befintliga
                    (48, 48, ''), (32, 32, '_32'),
                    # NYA storlekar f√∂r hero-modulen och b√§ttre kvalitet
                    (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')
                ],
                'wi-cloudy': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-cloudy': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-cloudy-high': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-rain': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-rain-mix': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-showers': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-sleet': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-snow': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-sunny': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-sunny-overcast': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-day-thunderstorm': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-fog': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-alt-cloudy': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-clear': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-cloudy-high': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-partly-cloudy': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-rain': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-rain-mix': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-showers': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-sleet': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-snow': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-night-thunderstorm': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-rain': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-rain-mix': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-sleet': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-snow': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-thunderstorm': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')],
                'wi-na': [(48, 48, ''), (32, 32, '_32'), (64, 64, '_64'), (80, 80, '_80'), (96, 96, '_96'), (120, 120, '_120')]
            }
        }
    
    def backup_existing_png(self, png_path):
        """
        S√§kerhetskopiera befintlig PNG-fil
        
        Args:
            png_path: S√∂kv√§g till PNG-fil
            
        Returns:
            True om backup lyckades
        """
        try:
            if png_path.exists():
                # Skapa samma katalogstruktur i backup
                relative_path = png_path.relative_to(self.icons_dir)
                backup_path = self.backup_dir / relative_path
                backup_path.parent.mkdir(parents=True, exist_ok=True)
                
                shutil.copy2(png_path, backup_path)
                self.stats['backed_up'] += 1
                self.logger.debug(f"üíæ Backup: {png_path} ‚Üí {backup_path}")
                return True
            return True
        except Exception as e:
            self.logger.error(f"‚ùå Backup misslyckades f√∂r {png_path}: {e}")
            return False
    
    def convert_svg_to_png(self, svg_path, png_path, width, height, is_new_size=False):
        """
        Konvertera SVG till PNG med given storlek
        
        Args:
            svg_path: S√∂kv√§g till SVG-fil
            png_path: S√∂kv√§g f√∂r PNG-utdata
            width, height: M√•l-storlek
            is_new_size: Om detta √§r en ny storlek (inte ers√§ttning)
            
        Returns:
            True om konvertering lyckades
        """
        try:
            # Skapa temp-fil f√∂r s√§ker √∂verskrivning
            temp_path = png_path.with_suffix('.tmp')
            
            # Konvertera SVG ‚Üí PNG med cairosvg
            cairosvg.svg2png(
                url=str(svg_path),
                write_to=str(temp_path),
                output_width=width,
                output_height=height,
                background_color='white'
            )
            
            # Optimera f√∂r E-Paper
            self.optimize_for_epaper(temp_path)
            
            # Atomisk √∂verskrivning
            shutil.move(temp_path, png_path)
            
            status = "üÜï SKAPAD" if is_new_size else "‚úÖ KONVERTERAD"
            self.logger.debug(f"{status}: {svg_path.name} ‚Üí {png_path.name} ({width}√ó{height})")
            
            if is_new_size:
                self.stats['new_created'] += 1
            else:
                self.stats['converted'] += 1
                
            return True
            
        except Exception as e:
            self.logger.error(f"‚ùå Konvertering misslyckades {svg_path.name}: {e}")
            # Rensa temp-fil om den finns
            if temp_path.exists():
                temp_path.unlink()
            return False
    
    def optimize_for_epaper(self, png_path):
        """
        Optimera PNG f√∂r E-Paper display (1-bit svartvit)
        F√ñRB√ÑTTRAD f√∂r h√∂gre uppl√∂sningar
        
        Args:
            png_path: S√∂kv√§g till PNG-fil att optimera
        """
        try:
            # Ladda bilden
            image = Image.open(png_path)
            
            # Konvertera till RGB om n√∂dv√§ndigt (hantera transparens)
            if image.mode in ('RGBA', 'LA'):
                # Skapa vit bakgrund f√∂r transparens
                background = Image.new('RGB', image.size, (255, 255, 255))
                if image.mode == 'RGBA':
                    background.paste(image, mask=image.split()[-1])
                else:
                    background.paste(image, mask=image.split()[-1])
                image = background
            elif image.mode != 'RGB':
                image = image.convert('RGB')
            
            # Konvertera till grayscale
            image = image.convert('L')
            
            # E-Paper optimering - F√ñRB√ÑTTRAD f√∂r h√∂gre uppl√∂sningar
            # Dynamisk kontrast baserat p√• storlek
            size = max(image.size)
            if size >= 96:
                # H√∂gre uppl√∂sning: mindre aggressiv kontrast f√∂r att bevara detaljer
                contrast_factor = 2.0
                sharpness_factor = 1.3
            elif size >= 64:
                # Medium uppl√∂sning
                contrast_factor = 2.1
                sharpness_factor = 1.4
            else:
                # L√•g uppl√∂sning: mer aggressiv f√∂r tydlighet
                contrast_factor = 2.3
                sharpness_factor = 1.5
            
            # √ñka kontrast
            contrast_enhancer = ImageEnhance.Contrast(image)
            image = contrast_enhancer.enhance(contrast_factor)
            
            # F√∂rb√§ttra sk√§rpa
            sharpness_enhancer = ImageEnhance.Sharpness(image)
            image = sharpness_enhancer.enhance(sharpness_factor)
            
            # Justera ljusstyrka
            brightness_enhancer = ImageEnhance.Brightness(image)
            image = brightness_enhancer.enhance(1.1)
            
            # Konvertera till 1-bit svartvit med Floyd-Steinberg dithering
            image = image.convert('1', dither=Image.Dither.FLOYDSTEINBERG)
            
            # Spara optimerad version
            image.save(png_path, 'PNG', optimize=True)
            
        except Exception as e:
            self.logger.error(f"‚ùå E-Paper optimering misslyckades f√∂r {png_path}: {e}")
    
    def convert_category(self, category, icon_mapping):
        """
        Konvertera en kategori av ikoner
        
        Args:
            category: Kategorinamn ('pressure', 'system', 'sun', 'weather')
            icon_mapping: Dict med ikon-mappningar
            
        Returns:
            Dict med resultat-statistik
        """
        category_stats = {'converted': 0, 'new_created': 0, 'skipped': 0, 'failed': 0}
        category_dir = self.icons_dir / category
        
        print(f"\nüîÑ Konverterar {category} ikoner...")
        print(f"üìÅ M√•l: {category_dir}")
        
        for icon_name, size_specs in icon_mapping.items():
            svg_path = self.svg_base_dir / f"{icon_name}.svg"
            
            # Kontrollera att SVG finns
            if not svg_path.exists():
                self.logger.warning(f"‚ö†Ô∏è SVG saknas: {svg_path}")
                category_stats['failed'] += len(size_specs)
                continue
            
            # Konvertera alla storlekar f√∂r denna ikon
            for width, height, suffix in size_specs:
                png_name = f"{icon_name}{suffix}.png"
                png_path = category_dir / png_name
                
                # Kontrollera om detta √§r en befintlig eller ny storlek
                is_new_size = not png_path.exists()
                
                if not is_new_size:
                    # Backup befintlig PNG
                    if not self.backup_existing_png(png_path):
                        category_stats['failed'] += 1
                        continue
                
                # Konvertera SVG ‚Üí PNG
                if self.convert_svg_to_png(svg_path, png_path, width, height, is_new_size):
                    if is_new_size:
                        category_stats['new_created'] += 1
                        print(f"  üÜï {icon_name}{suffix}.png ({width}√ó{height}) - NY STORLEK")
                    else:
                        category_stats['converted'] += 1
                        print(f"  ‚úÖ {icon_name}{suffix}.png ({width}√ó{height}) - F√ñRB√ÑTTRAD")
                else:
                    category_stats['failed'] += 1
                    print(f"  ‚ùå {icon_name}{suffix}.png MISSLYCKADES")
        
        return category_stats
    
    def run_conversion(self, categories=None):
        """
        K√∂r konvertering av specificerade kategorier
        
        Args:
            categories: Lista med kategorier att konvertera ['pressure', 'system', 'sun', 'weather']
                       Om None, konvertera alla
        """
        if categories is None:
            categories = ['pressure', 'system', 'sun', 'weather']
        
        # Nollst√§ll statistik f√∂r denna k√∂rning
        self.stats = {'converted': 0, 'new_created': 0, 'skipped': 0, 'failed': 0, 'backed_up': 0}
        
        print(f"üöÄ Startar SVG‚ÜíPNG konvertering MED H√ñGRE UPPL√ñSNINGAR")
        print(f"üìÇ Kategorier: {', '.join(categories)}")
        print(f"üéØ Nya storlekar: 64x64, 80x80, 96x96, 120x120")
        
        conversion_mapping = self.get_conversion_mapping()
        
        total_start_time = datetime.now()
        
        for category in categories:
            if category in conversion_mapping:
                icon_mapping = conversion_mapping[category]
                category_stats = self.convert_category(category, icon_mapping)
                
                # Uppdatera total statistik
                for key in category_stats:
                    self.stats[key] += category_stats[key]
            else:
                print(f"‚ö†Ô∏è Ok√§nd kategori: {category}")
        
        total_duration = datetime.now() - total_start_time
        
        # Sammanfattning
        self.print_summary(total_duration, categories)
    
    def print_summary(self, duration, categories):
        """Skriv ut sammanfattning av konvertering"""
        print(f"\n" + "="*60)
        print(f"üé® SVG‚ÜíPNG KONVERTERING MED H√ñGRE UPPL√ñSNINGAR SLUTF√ñRD!")
        print(f"üìÇ Kategorier: {', '.join(categories)}")
        print(f"‚è±Ô∏è Tid: {duration.total_seconds():.1f} sekunder")
        print(f"")
        print(f"üìä RESULTAT:")
        print(f"  ‚úÖ F√∂rb√§ttrade: {self.stats['converted']} PNG-filer")
        print(f"  üÜï Nya storlekar: {self.stats['new_created']} PNG-filer")
        print(f"  ‚è≠Ô∏è Hoppade √∂ver: {self.stats['skipped']} filer")
        print(f"  ‚ùå Misslyckades: {self.stats['failed']} filer")
        print(f"  üíæ Backup: {self.stats['backed_up']} filer")
        print(f"")
        print(f"üéØ NYA STORLEKAR SKAPADE:")
        
        if 'weather' in categories:
            print(f"  üå§Ô∏è Weather-ikoner: Nu tillg√§ngliga i 32, 48, 64, 80, 96, 120px")
        if 'pressure' in categories:
            print(f"  ‚ÜóÔ∏è Pressure-pilar: Nu tillg√§ngliga i 20, 56, 96, 120px")
        if 'system' in categories:
            print(f"  üìä System-ikoner: Barometer tillg√§nglig i upp till 96px")
        if 'sun' in categories:
            print(f"  ‚òÄÔ∏è Sol-ikoner: Nu tillg√§ngliga i 24, 40, 56, 80px")
        
        print(f"")
        print(f"üìÅ Backup sparad i: {self.backup_dir}")
        
        if self.stats['converted'] + self.stats['new_created'] > 0:
            print(f"")
            print(f"üîß N√ÑSTA STEG:")
            print(f"1. Testa: cd ~/epaper_weather && python3 main.py")
            print(f"2. Nu kan main.py anv√§nda h√∂gre uppl√∂sningar:")
            print(f"   - HERO v√§derikon: 96x96 eller 120x120 (ej pixlig!)")
            print(f"   - Prognos v√§derikon: 64x64 eller 80x80")
            print(f"   - Barometer: 80x80 eller 96x96")
            print(f"   - Trycktrend-pil: 96x96 eller 120x120")
            print(f"")
            print(f"üí° PERFEKT KVALITET: Alla ikoner fr√•n SVG-k√§llor!")
        
        if self.stats['failed'] > 0:
            print(f"")
            print(f"‚ö†Ô∏è N√•gra konverteringar misslyckades.")
            print(f"üîç Kontrollera log-meddelanden ovan f√∂r detaljer.")
        
        print(f"="*60)
    
    def restore_from_backup(self):
        """√Öterst√§ll fr√•n senaste backup (f√∂r fels√∂kning)"""
        print(f"üîÑ √Öterst√§ller fr√•n backup: {self.backup_dir}")
        
        try:
            restored = 0
            for backup_file in self.backup_dir.rglob('*.png'):
                # R√§kna ut original-s√∂kv√§g
                relative_path = backup_file.relative_to(self.backup_dir)
                original_path = self.icons_dir / relative_path
                
                if original_path.exists():
                    shutil.copy2(backup_file, original_path)
                    restored += 1
            
            print(f"‚úÖ √Öterst√§llde {restored} filer fr√•n backup")
            
        except Exception as e:
            print(f"‚ùå √Öterst√§llning misslyckades: {e}")


def main():
    """Huvudfunktion"""
    print("üé® Weather Icons SVG‚ÜíPNG Converter - H√ñGRE UPPL√ñSNINGAR")
    print("Skapar nya storlekar: 64x64, 80x80, 96x96, 120x120 fr√•n SVG-k√§llor\n")
    
    try:
        # Skapa konverterare
        converter = WeatherIconsSVGConverter()
        
        # Fr√•ga anv√§ndaren om vad som ska konverteras
        print("TILLG√ÑNGLIGA KONVERTERINGAR:")
        print("1. üå§Ô∏è Weather-ikoner (~30 ikoner √ó 6 storlekar = ~180 filer)")
        print("2. ‚ÜóÔ∏è Pressure-pilar (3 ikoner √ó 4 storlekar = 12 filer)")
        print("3. üìä System-ikoner (~85 ikoner, ut√∂kade storlekar)")
        print("4. ‚òÄÔ∏è Sol-ikoner (3 ikoner √ó 4 storlekar = 12 filer)")
        print("5. üåç ALLA kategorier (alla nya storlekar)")
        print("6. üéØ BARA HERO-IKONER (weather + pressure f√∂r HERO-modulen)")
        
        while True:
            choice = input("\nV√§lj (1-6): ").strip().lower()
            
            if choice in ['1', 'weather', 'v√§der']:
                print("üå§Ô∏è Startar konvertering av weather-ikoner med h√∂gre uppl√∂sningar...")
                converter.run_conversion(categories=['weather'])
                break
            elif choice in ['2', 'pressure', 'tryck']:
                print("‚ÜóÔ∏è Startar konvertering av pressure-pilar med h√∂gre uppl√∂sningar...")
                converter.run_conversion(categories=['pressure'])
                break
            elif choice in ['3', 'system']:
                print("üìä Startar konvertering av system-ikoner med ut√∂kade storlekar...")
                converter.run_conversion(categories=['system'])
                break
            elif choice in ['4', 'sol', 'sun']:
                print("‚òÄÔ∏è Startar konvertering av sol-ikoner med h√∂gre uppl√∂sningar...")
                converter.run_conversion(categories=['sun'])
                break
            elif choice in ['5', 'alla', 'all', 'allt']:
                print("üåç Startar konvertering av ALLA kategorier med h√∂gre uppl√∂sningar...")
                converter.run_conversion(categories=['weather', 'pressure', 'system', 'sun'])
                break
            elif choice in ['6', 'hero']:
                print("üéØ Startar konvertering av HERO-ikoner (weather + pressure)...")
                converter.run_conversion(categories=['weather', 'pressure'])
                break
            else:
                print(f"‚ùå Ogiltigt val: '{choice}'")
                print("üí° Ange 1-6 eller weather/pressure/system/sun/alla/hero")
    
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è Konvertering avbruten av anv√§ndare")
    except Exception as e:
        print(f"‚ùå Kritiskt fel: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
